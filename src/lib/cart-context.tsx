'use client';

import React, { createContext, useContext, useState, useEffect } from 'react';
import { getCustomerAuthHeaders, useCustomerAuth } from './auth-customer';

const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5001';

interface CartItem {\n    id: string;\n    product_id: string;\n    name: string;\n    price: string;\n    mrp: string;\n    quantity: number;\n    images: string[];\n    stock_quantity: number;\n}\n\ninterface CartSummary {\n    totalAmount: number;\n    totalItems: number;\n}\n\ninterface CartContextType {\n    items: CartItem[];\n    summary: CartSummary;\n    loading: boolean;\n    addToCart: (productId: string, quantity: number) => Promise<{ success: boolean; error?: string }>;\n    updateQuantity: (itemId: string, quantity: number) => Promise<void>;\n    removeFromCart: (itemId: string) => Promise<void>;\n    refreshCart: () => Promise<void>;\n}\n\nconst CartContext = createContext<CartContextType | undefined>(undefined);\n\nexport function CartProvider({ children }: { children: React.ReactNode }) {\n    const { isAuthenticated } = useCustomerAuth();\n    const [items, setItems] = useState<CartItem[]>([]);\n    const [summary, setSummary] = useState<CartSummary>({ totalAmount: 0, totalItems: 0 });\n    const [loading, setLoading] = useState(false);\n\n    const fetchCart = async () => {\n        if (!isAuthenticated) {\n            setItems([]);\n            setSummary({ totalAmount: 0, totalItems: 0 });\n            return;\n        }\n        setLoading(true);\n        try {\n            const res = await fetch(`${API_BASE}/api/cart`, {\n                headers: getCustomerAuthHeaders(),\n            });\n            if (res.ok) {\n                const data = await res.json();\n                setItems(data.items);\n                setSummary(data.summary);\n            }\n        } catch (err) {\n            console.error('Fetch cart error:', err);\n        } finally {\n            setLoading(false);\n        }\n    };\n\n    useEffect(() => {\n        fetchCart();\n    }, [isAuthenticated]);\n\n    const addToCart = async (productId: string, quantity: number) => {\n        try {\n            const res = await fetch(`${API_BASE}/api/cart`, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json',\n                    ...getCustomerAuthHeaders(),\n                },\n                body: JSON.stringify({ productId, quantity }),\n            });\n            const data = await res.json();\n            if (res.ok) {\n                await fetchCart();\n                return { success: true };\n            }\n            return { success: false, error: data.error };\n        } catch (err) {\n            return { success: false, error: 'Network error' };\n        }\n    };\n\n    const updateQuantity = async (itemId: string, quantity: number) => {\n        try {\n            const res = await fetch(`${API_BASE}/api/cart/${itemId}`, {\n                method: 'PUT',\n                headers: {\n                    'Content-Type': 'application/json',\n                    ...getCustomerAuthHeaders(),\n                },\n                body: JSON.stringify({ quantity }),\n            });\n            if (res.ok) await fetchCart();\n        } catch (err) {\n            console.error('Update qty error:', err);\n        }\n    };\n\n    const removeFromCart = async (itemId: string) => {\n        try {\n            const res = await fetch(`${API_BASE}/api/cart/${itemId}`, {\n                method: 'DELETE',\n                headers: getCustomerAuthHeaders(),\n            });\n            if (res.ok) await fetchCart();\n        } catch (err) {\n            console.error('Remove from cart error:', err);\n        }\n    };\n\n    return (\n        <CartContext.Provider\n            value={{ items, summary, loading, addToCart, updateQuantity, removeFromCart, refreshCart: fetchCart }}\n        >\n            {children}\n        </CartContext.Provider>\n    );\n}\n\nexport const useCart = () => {\n    const context = useContext(CartContext);\n    if (!context) throw new Error('useCart must be used within CartProvider');\n    return context;\n};\n