'use client';

import React, { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/Card';
import { Button } from '@/components/ui/Button';
import { Loader2, Plus, X, Upload, Check, AlertCircle, Trash2, Package } from 'lucide-react';
import { getAuthHeaders } from '@/lib/auth';

const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5001';

export interface ProductFormData {
    id?: string;
    name: string;
    slug: string;
    description: string;
    price: string;
    mrp: string;
    stock_quantity: string;
    images: string[];
    category: string;
    status: string;
}

interface ProductFormProps {
    initialData?: ProductFormData;
    mode: 'create' | 'edit';
}

const CATEGORIES = [\n    'Fitness', 'Nutrition', 'Medical Devices', 'Mental Health', 'Health Screening', 'Wellness Services'\n];

export default function ProductForm({ initialData, mode }: ProductFormProps) {\n    const router = useRouter();\n    const [form, setForm] = useState<ProductFormData>(initialData || {\n        name: '',\n        slug: '',\n        description: '',\n        price: '',\n        mrp: '',\n        stock_quantity: '0',\n        images: [],\n        category: CATEGORIES[0],\n        status: 'DRAFT',\n    });\n\n    const [saving, setSaving] = useState(false);\n    const [uploading, setUploading] = useState(false);\n    const [error, setError] = useState('');\n    const [success, setSuccess] = useState(false);\n\n    async function handleUpload(e: React.ChangeEvent<HTMLInputElement>) {\n        const file = e.target.files?.[0];\n        if (!file) return;\n\n        setUploading(true);\n        setError('');\n\n        const formData = new FormData();\n        formData.append('image', file);\n\n        try {\n            const res = await fetch(`${API_BASE}/api/upload`, {\n                method: 'POST',\n                headers: {\n                    ...getAuthHeaders(),\n                },\n                body: formData,\n            });\n\n            const data = await res.json();\n            if (res.ok) {\n                setForm(prev => ({ ...prev, images: [...prev.images, data.url] }));\n            } else {\n                setError(data.error || 'Upload failed');\n            }\n        } catch (err) {\n            setError('Failed to connect to server');\n        } finally {\n            setUploading(false);\n        }\n    }\n\n    async function handleSave(publishAfterSave = false) {\n        // Basic Validation\n        if (!form.name || !form.price || !form.mrp) {\n            setError('Name, Price, and MRP are required.');\n            return;\n        }\n\n        setSaving(true);\n        setError('');\n        setSuccess(false);\n\n        try {\n            const payload = {\n                ...form,\n                price: parseFloat(form.price),\n                mrp: parseFloat(form.mrp),\n                stock_quantity: parseInt(form.stock_quantity),\n                status: publishAfterSave ? 'PUBLISHED' : form.status,\n            };\n\n            const url = mode === 'create' ? `${API_BASE}/api/products` : `${API_BASE}/api/products/${form.id}`;\n            const method = mode === 'create' ? 'POST' : 'PUT';\n\n            const res = await fetch(url, {\n                method,\n                headers: {\n                    'Content-Type': 'application/json',\n                    ...getAuthHeaders(),\n                },\n                body: JSON.stringify(payload),\n            });\n\n            const data = await res.json();\n\n            if (res.ok) {\n                setSuccess(true);\n                if (mode === 'create') {\n                    router.push('/admin');\n                } else {\n                    // Update local form state with potentially updated data (like slug)\n                    setForm(prev => ({ ...prev, ...data, \n                        price: String(data.price), \n                        mrp: String(data.mrp), \n                        stock_quantity: String(data.stock_quantity) \n                    }));\n                }\n            } else {\n                setError(data.error || 'Failed to save product.');\n            }\n        } catch (err: any) {\n            setError(err.message || 'Failed to save product.');\n        } finally {\n            setSaving(false);\n        }\n    }\n\n    return (\n        <div className=\"max-w-4xl\">\n            <div className=\"flex items-center justify-between mb-8\">\n                <h1 className=\"text-2xl font-bold text-slate-900\" style={{ fontFamily: 'Raleway' }}>\n                    {mode === 'create' ? 'Add New Product' : 'Edit Product'}\n                </h1>\n                <div className=\"flex items-center gap-3\">\n                    <Button \n                        variant=\"outline\" \n                        onClick={() => router.push('/admin')}\n                        disabled={saving}\n                    >\n                        Cancel\n                    </Button>\n                    <Button \n                        onClick={() => handleSave(false)} \n                        disabled={saving}\n                        className=\"bg-slate-800 hover:bg-slate-900 text-white\"\n                    >\n                        {saving ? <Loader2 className=\"animate-spin mr-2\" size={18} /> : null}\n                        Save Draft\n                    </Button>\n                    <Button \n                        onClick={() => handleSave(true)} \n                        disabled={saving}\n                        className=\"bg-[#00A59B] hover:bg-[#008C84] text-white\"\n                    >\n                        {saving ? <Loader2 className=\"animate-spin mr-2\" size={18} /> : null}\n                        {form.status === 'PUBLISHED' ? 'Update & Sync' : 'Publish Product'}\n                    </Button>\n                </div>\n            </div>\n\n            {error && (\n                <div className=\"bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-xl mb-6 flex items-center gap-3 animate-in fade-in slide-in-from-top-2\">\n                    <AlertCircle size={20} />\n                    <span className=\"text-sm font-medium\">{error}</span>\n                </div>\n            )}\n\n            {success && (\n                <div className=\"bg-emerald-50 border border-emerald-200 text-emerald-600 px-4 py-3 rounded-xl mb-6 flex items-center gap-3 animate-in fade-in slide-in-from-top-2\">\n                    <Check size={20} />\n                    <span className=\"text-sm font-medium\">Product saved successfully!</span>\n                </div>\n            )}\n\n            <div className=\"grid lg:grid-cols-3 gap-8\">\n                <div className=\"lg:col-span-2 space-y-6\">\n                    <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm\">\n                        <h2 className=\"text-sm font-bold text-slate-400 uppercase tracking-widest mb-6\">Basic Information</h2>\n                        <div className=\"space-y-5\">\n                            <div>\n                                <label htmlFor=\"name\" className=\"block text-sm font-semibold text-slate-700 mb-1.5\">Product Name</label>\n                                <input\n                                    id=\"name\"\n                                    type=\"text\"\n                                    value={form.name}\n                                    onChange={e => setForm({ ...form, name: e.target.value })}\n                                    placeholder=\"e.g. Premium Yoga Mat\"\n                                    className=\"w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-900 outline-none focus:bg-white focus:ring-2 focus:ring-[#00A59B]/20 focus:border-[#00A59B] transition-all\"\n                                />\n                            </div>\n                            <div>\n                                <label htmlFor=\"slug\" className=\"block text-sm font-semibold text-slate-700 mb-1.5\">Custom Slug (Optional)</label>\n                                <input\n                                    id=\"slug\"\n                                    type=\"text\"\n                                    value={form.slug}\n                                    onChange={e => setForm({ ...form, slug: e.target.value })}\n                                    placeholder=\"e.g. custom-url-slug\"\n                                    className=\"w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-900 outline-none focus:bg-white focus:ring-2 focus:ring-[#00A59B]/20 focus:border-[#00A59B] transition-all text-xs font-mono\"\n                                />\n                            </div>\n                            <div>\n                                <label htmlFor=\"description\" className=\"block text-sm font-semibold text-slate-700 mb-1.5\">Description</label>\n                                <textarea\n                                    id=\"description\"\n                                    rows={6}\n                                    value={form.description}\n                                    onChange={e => setForm({ ...form, description: e.target.value })}\n                                    placeholder=\"Describe the product features, benefits, and specifications...\"\n                                    className=\"w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-900 outline-none focus:bg-white focus:ring-2 focus:ring-[#00A59B]/20 focus:border-[#00A59B] transition-all\"\n                                />\n                            </div>\n                        </div>\n                    </div>\n\n                    <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm\">\n                        <h2 className=\"text-sm font-bold text-slate-400 uppercase tracking-widest mb-6\">Media</h2>\n                        <div className=\"grid grid-cols-4 gap-4\">\n                            {form.images.map((url, idx) => (\n                                <div key={idx} className=\"relative aspect-square rounded-xl overflow-hidden border border-slate-100 group\">\n                                    <img src={url} alt=\"Preview\" className=\"w-full h-full object-cover\" />\n                                    <button \n                                        onClick={() => setForm(prev => ({ ...prev, images: prev.images.filter((_, i) => i !== idx) }))}\n                                        className=\"absolute top-1.5 right-1.5 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity\"\n                                    >\n                                        <X size={14} />\n                                    </button>\n                                </div>\n                            ))}\n                            <label className=\"aspect-square flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-xl hover:border-[#00A59B] hover:bg-[#00A59B]/5 cursor-pointer transition-all\">\n                                <input type=\"file\" accept=\"image/*\" onChange={handleUpload} className=\"hidden\" />\n                                {uploading ? <Loader2 size={24} className=\"animate-spin text-[#00A59B]\" /> : <Upload size={24} className=\"text-slate-400\" />}\n                                <span className=\"text-[10px] font-bold text-slate-500 mt-2 uppercase tracking-tighter\">{uploading ? 'Uploading...' : 'Add Image'}</span>\n                            </label>\n                        </div>\n                    </div>\n                </div>\n\n                <div className=\"space-y-6\">\n                    <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm\">\n                        <h2 className=\"text-sm font-bold text-slate-400 uppercase tracking-widest mb-6\">Pricing & Inventory</h2>\n                        <div className=\"space-y-4\">\n                            <div>\n                                <label htmlFor=\"price\" className=\"block text-sm font-semibold text-slate-700 mb-1.5\">Selling Price (₹)</label>\n                                <input\n                                    id=\"price\"\n                                    type=\"number\"\n                                    value={form.price}\n                                    onChange={e => setForm({ ...form, price: e.target.value })}\n                                    className=\"w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-900 outline-none focus:bg-white focus:ring-2 focus:ring-[#00A59B]/20 focus:border-[#00A59B] transition-all font-semibold\"\n                                />\n                            </div>\n                            <div>\n                                <label htmlFor=\"mrp\" className=\"block text-sm font-semibold text-slate-700 mb-1.5\">MRP (₹)</label>\n                                <input\n                                    id=\"mrp\"\n                                    type=\"number\"\n                                    value={form.mrp}\n                                    onChange={e => setForm({ ...form, mrp: e.target.value })}\n                                    className=\"w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-900 outline-none focus:bg-white focus:ring-2 focus:ring-[#00A59B]/20 focus:border-[#00A59B] transition-all\"\n                                />\n                            </div>\n                            <hr className=\"border-slate-100\" />\n                            <div>\n                                <label htmlFor=\"stock\" className=\"block text-sm font-semibold text-slate-700 mb-1.5\">Stock Quantity</label>\n                                <input\n                                    id=\"stock\"\n                                    type=\"number\"\n                                    value={form.stock_quantity}\n                                    onChange={e => setForm({ ...form, stock_quantity: e.target.value })}\n                                    className=\"w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-900 outline-none focus:bg-white focus:ring-2 focus:ring-[#00A59B]/20 focus:border-[#00A59B] transition-all\"\n                                />\n                            </div>\n                        </div>\n                    </div>\n\n                    <div className=\"bg-white p-6 rounded-2xl border border-slate-200 shadow-sm\">\n                        <h2 className=\"text-sm font-bold text-slate-400 uppercase tracking-widest mb-6\">Organization</h2>\n                        <div className=\"space-y-4\">\n                            <div>\n                                <label htmlFor=\"category\" className=\"block text-sm font-semibold text-slate-700 mb-1.5\">Category</label>\n                                <select\n                                    id=\"category\"\n                                    value={form.category}\n                                    onChange={e => setForm({ ...form, category: e.target.value })}\n                                    className=\"w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-slate-900 outline-none focus:bg-white focus:ring-2 focus:ring-[#00A59B]/20 transition-all\"\n                                >\n                                    {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}\n                                </select>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div className=\"bg-slate-50 p-4 rounded-2xl border border-slate-200\">\n                        <div className=\"flex items-center gap-2 mb-2\">\n                            <Package size={16} className=\"text-slate-400\" />\n                            <span className=\"text-xs font-bold text-slate-400 uppercase\">Status</span>\n                        </div>\n                        <div className=\"flex items-center justify-between\">\n                            <span className={`text-sm font-bold ${form.status === 'PUBLISHED' ? 'text-emerald-600' : 'text-slate-500'}`}>\n                                {form.status}\n                            </span>\n                            <div className={`w-2 h-2 rounded-full ${form.status === 'PUBLISHED' ? 'bg-emerald-500 animate-pulse' : 'bg-slate-300'}`} />\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n}
